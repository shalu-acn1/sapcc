import{c as Ke}from"./chunk-4QGFQKK3.js";import{a as Ve,c as J,d as _,e as X,f as D,g as $e,h as I,i as h,j as k,k as ze}from"./chunk-RFZPD5QM.js";import{b as ne,d as Ye}from"./chunk-TTSQTH3J.js";import"./chunk-RFSWRLY7.js";import{a as Ge,b as Ue,d as Le,e as xe,g as We,i as qe,k as je,m as He}from"./chunk-QKV5QP3B.js";import{d as Re,u as we,x as Ne,y as Qe}from"./chunk-FHULHBP4.js";import"./chunk-WPN2OLOU.js";import"./chunk-3OH6C4VK.js";import{C as K,H as F,I as _e,J as Z}from"./chunk-EU5ZHKTW.js";import{oa as re}from"./chunk-H2QHHFZD.js";import{$b as x,Ab as me,Bb as B,Cc as j,D as S,Hb as Se,I as P,Ib as Pe,Ic as M,J as de,Jb as Ce,Kd as H,Le as ke,M as o,Oc as De,Pa as N,Te as Ee,U as le,Uc as Te,Ya as Q,Za as v,Ze as Oe,_d as b,_e as Be,ac as W,af as be,b as oe,bb as T,d as ce,da as a,ee as ie,fh as Fe,ga as C,gc as Ae,he as Y,ib as m,m as pe,ma as f,me as Me,mf as $,n as l,na as g,o as E,oa as ue,p as te,q as u,qa as n,r as O,rf as z,sb as fe,tb as ge,ub as G,va as he,vb as U,w,wa as ye,wb as L,we as Ie,xc as q,yb as ve,ye as V}from"./chunk-PRP3ZKGZ.js";import{a as d,b as y}from"./chunk-25N2FLV6.js";var R=class{},Je=(()=>{class i{constructor(){this.adapter=n(R)}getApplePayWebSession(e,t){return this.adapter.getApplePayWebSession(e,t)}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=f({token:i,factory:i.\u0275fac})}}return i})(),Ze=(()=>{class i{constructor(){this.commandService=n(ke),this.opfQuickBuyConnector=n(Je),this.cartAccessCodeFacade=n(_e),this.activeCartFacade=n(F),this.userIdService=n(b),this.logger=n(Y),this.applePaySessionCommand=this.commandService.create(e=>O([this.userIdService.getUserId(),this.activeCartFacade.getActiveCartId()]).pipe(S(([t,r])=>!!r&&!!t),a(([t,r])=>this.cartAccessCodeFacade.getCartAccessCode(t,r)),S(t=>!!t?.accessCode),o(1),de(({accessCode:t})=>this.opfQuickBuyConnector.getApplePayWebSession(e.applePayWebSessionRequest,t)),P(t=>{throw z(t,this.logger)}),$({shouldRetry:Be,maxTries:be})))}getApplePayWebSession(e){return this.applePaySessionCommand.execute({applePayWebSessionRequest:e})}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=f({token:i,factory:i.\u0275fac})}}return i})(),at=[Ze,{provide:J,useExisting:Ze}],Xe=(()=>{class i{static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275mod=v({type:i})}static{this.\u0275inj=g({providers:[...at,Je]})}}return i})(),ee=(()=>{class i{constructor(){this.baseSiteService=n(Ie),this.activeCartFacade=n(F),this.routingService=n(Me),this.checkoutDeliveryModesFacade=n(Qe),this.checkoutDeliveryAddressFacade=n(we),this.checkoutBillingAddressFacade=n(Ne),this.userAddressService=n(Fe),this.opfGlobalMessageService=n(xe),this.cartGuestUserFacade=n(Z),this.authService=n(V),this.userIdService=n(b),this.multiCartFacade=n(K)}getTransactionDeliveryType(){return this.activeCartFacade.hasDeliveryItems().pipe(o(1),u(e=>e?h.SHIPPING:h.PICKUP))}getTransactionDeliveryInfo(){return this.getTransactionDeliveryType().pipe(u(t=>({type:t}))).pipe(o(1))}getTransactionLocationContext(){return this.routingService.getRouterState().pipe(o(1),u(e=>e?.state?.semanticRoute?.toLocaleUpperCase()))}getMerchantName(){return this.baseSiteService.get().pipe(o(1),u(e=>e?.name??_))}checkStableCart(){return this.activeCartFacade.isStable().pipe(S(e=>!!e),o(1))}getSupportedDeliveryModes(){return this.checkoutDeliveryModesFacade.getSupportedDeliveryModes()}setDeliveryAddress(e){return this.opfGlobalMessageService.disableGlobalMessage(["addressForm.userAddressAddSuccess"]),this.checkoutDeliveryAddressFacade.createAndSetAddress(e).pipe(a(()=>this.checkStableCart()),a(()=>this.getDeliveryAddress().pipe(u(t=>t?.id??""))))}setBillingAddress(e){return this.checkoutBillingAddressFacade.setBillingAddress(e).pipe(a(()=>this.checkStableCart()))}getDeliveryAddress(){return this.checkoutDeliveryAddressFacade.getDeliveryAddressState().pipe(S(e=>!e.loading),o(1),u(e=>e.data))}getCurrentCart(){return this.activeCartFacade.takeActive()}getCurrentCartId(){return this.activeCartFacade.takeActiveCartId()}getCurrentCartTotalPrice(){return this.activeCartFacade.takeActive().pipe(u(e=>e.totalPrice?.value))}setDeliveryMode(e){return this.checkoutDeliveryModesFacade.setDeliveryMode(e).pipe(a(()=>this.checkoutDeliveryModesFacade.getSelectedDeliveryModeState()),S(t=>!t.error&&!t.loading),o(1),u(t=>t.data))}getSelectedDeliveryMode(){return this.checkoutDeliveryModesFacade.getSelectedDeliveryModeState().pipe(S(e=>!e.error&&!e.loading),o(1),u(e=>e.data))}deleteUserAddresses(e){this.authService.isUserLoggedIn().pipe(o(1)).subscribe(t=>{t&&(this.opfGlobalMessageService.disableGlobalMessage(["addressForm.userAddressDeleteSuccess"]),e.forEach(r=>{this.userAddressService.deleteUserAddress(r)}))})}createCartGuestUser(){return O([this.userIdService.takeUserId(),this.activeCartFacade.takeActiveCartId()]).pipe(o(1),a(([e,t])=>this.cartGuestUserFacade.createCartGuestUser(e,t).pipe(C(()=>this.multiCartFacade.reloadCart(t)),u(()=>!0))))}updateCartGuestUser(e){return O([this.userIdService.takeUserId(),this.activeCartFacade.takeActiveCartId()]).pipe(o(1),a(([t,r])=>this.cartGuestUserFacade.updateCartGuestUser(t,r,e).pipe(C(()=>this.multiCartFacade.reloadCart(r)),u(()=>!0))))}updateCartGuestUserEmail(e){return this.activeCartFacade.isGuestCart().pipe(o(1),a(t=>t&&e?this.updateCartGuestUser({email:e}):l(!1)))}handleCartGuestUser(){return O([this.authService.isUserLoggedIn(),this.activeCartFacade.isGuestCart()]).pipe(o(1),a(([e,t])=>e||t?l(!0):this.createCartGuestUser()))}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=f({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})(),et=new ue("OpfApplePayWebSession");function st(i,A){if(i&1){let e=ve();U(0),fe(1,"div",1),me("click",function(){he(e);let r=B();return ye(r.initTransaction())}),ge(),L()}}var ot=["googlePayButtonContainer"];function ct(i,A){i&1&&G(0,"div",3,0)}function pt(i,A){if(i&1&&(U(0),T(1,ct,2,0,"div",2),L()),i&2){let e=A.ngIf;N(),m("ngIf",e)}}function dt(i,A){if(i&1&&G(0,"cx-opf-apple-pay",2),i&2){let e=B().ngIf;m("activeConfiguration",e)}}function lt(i,A){if(i&1&&G(0,"cx-opf-google-pay",2),i&2){let e=B().ngIf;m("activeConfiguration",e)}}function ut(i,A){if(i&1&&(U(0),T(1,dt,1,1,"cx-opf-apple-pay",1)(2,lt,1,1,"cx-opf-google-pay",1),L()),i&2){let e=A.ngIf,t=B();N(),m("ngIf",t.isPaymentMethodEnabled(t.PAYMENT_METHODS.APPLE_PAY,e)),N(),m("ngIf",t.isPaymentMethodEnabled(t.PAYMENT_METHODS.GOOGLE_PAY,e))}}var tt=(()=>{class i{initialize(){this.applePaySession=this.getApplePaySession(),this.applePaySession&&(this.isDeviceSupported=this.applePaySession.canMakePayments())}constructor(){this.winRef=n(ie),this.isDeviceSupported=!1,this.applePayApiVersion=3,this.initialize()}getApplePaySession(){let e=this.winRef.nativeWindow;if(e.ApplePaySession)return e.ApplePaySession}get statusSuccess(){return this.isDeviceSupported?this.applePaySession.STATUS_SUCCESS:1}get statusFailure(){return this.isDeviceSupported?this.applePaySession.STATUS_FAILURE:1}isApplePaySupported(e){return this.isDeviceSupported&&this.supportsVersion(this.applePayApiVersion)?this.canMakePaymentsWithActiveCard(e):l(!1)}supportsVersion(e){try{return this.isDeviceSupported&&this.applePaySession.supportsVersion(e)}catch{return!1}}canMakePayments(){try{return this.isDeviceSupported&&this.applePaySession.canMakePayments()}catch{return!1}}canMakePaymentsWithActiveCard(e){return this.isDeviceSupported?pe(this.applePaySession.canMakePaymentsWithActiveCard(e)):l(!1)}createSession(e){return this.isDeviceSupported?new this.applePaySession(this.applePayApiVersion,e):void 0}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=f({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})(),ht=(()=>{class i{constructor(){this.applePaySessionWrapperService=n(tt)}start(e){return new oe(t=>{let r;try{r=this.applePaySessionWrapperService.createSession(e.request)}catch(c){t.error(c);return}let s=c=>{r.abort(),t.error(c)};r.addEventListener(D.VALIDATE_MERCHANT,c=>{e.onValidateMerchant(c).pipe(o(1)).subscribe({next:p=>{r.completeMerchantValidation(p)},error:s})}),r.addEventListener(D.CANCEL,()=>{t.error({type:Ye.PAYMENT_CANCELLED})}),e.onPaymentMethodSelected&&r.addEventListener(D.PAYMENT_METHOD_SELECTED,c=>{e.onPaymentMethodSelected(c).pipe(o(1)).subscribe({next:p=>{r.completePaymentMethodSelection(p)},error:s})}),e.onShippingContactSelected&&!this.isShippingTypePickup(e)&&r.addEventListener(D.SHIPPING_CONTACT_SELECTED,c=>{e.onShippingContactSelected(c).pipe(o(1)).subscribe({next:p=>{r.completeShippingContactSelection(p)},error:s})}),e.onShippingMethodSelected&&!this.isShippingTypePickup(e)&&r.addEventListener(D.SHIPPING_METHOD_SELECTED,c=>{e.onShippingMethodSelected(c).pipe(o(1)).subscribe({next:p=>{r.completeShippingMethodSelection(p)},error:s})}),r.addEventListener(D.PAYMENT_AUTHORIZED,c=>{e.onPaymentAuthorized(c).pipe(o(1)).subscribe({next:p=>{r.completePayment(p),p?.errors?.length?s({message:p?.errors[0]?.message}):(t.next(p),t.complete())},error:s})}),r.begin()})}isShippingTypePickup(e){return e.request.shippingType===$e.STORE_PICKUP}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=f({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})(),yt=(()=>{class i{constructor(){this.opfPaymentFacade=n(ne),this.applePaySessionWrapperService=n(tt),this.applePaySessionOrchestrator=n(ht),this.winRef=n(ie),this.opfQuickBuyTransactionService=n(ee),this.opfQuickBuyFacade=n(J),this.paymentInProgress=!1,this.defaultApplePayCardParameters={shippingMethods:[],merchantCapabilities:["supports3DS"],supportedNetworks:["visa","masterCard","amex","discover"],requiredShippingContactFields:["email","name","postalAddress"],requiredBillingContactFields:["email","name","postalAddress"]},this.initialTransactionDetails={context:I.PRODUCT,product:void 0,cart:void 0,quantity:0,addressIds:[],total:{label:_,amount:"",currency:""},deliveryInfo:{type:h.SHIPPING,pickupDetails:void 0}},this.transactionDetails=this.initialTransactionDetails}initTransactionDetails(e){if(this.transactionDetails=y(d({},this.initialTransactionDetails),{addressIds:[]}),e?.cart&&(this.transactionDetails=y(d({},this.transactionDetails),{context:I.CART,cart:e.cart,total:{amount:`${e.cart.totalPrice?.value}`,label:`${e.cart.code}`,currency:e.cart?.totalPrice?.currencyIso}})),e?.product&&e?.quantity){let r=e.product.price?.value*e.quantity;this.transactionDetails=y(d({},this.transactionDetails),{context:I.PRODUCT,product:e.product,quantity:e.quantity,total:{amount:r.toString(),label:`${e.product?.name}${e.quantity>1?` x ${e.quantity}`:""}`,currency:e.product?.price?.currencyIso}})}return this.transactionDetails}start(e){return this.paymentInProgress?E(()=>new Error("Apple Pay is already in progress")):(this.paymentInProgress=!0,this.setApplePayRequestConfig(e).pipe(a(t=>this.applePaySessionOrchestrator.start({request:t,onValidateMerchant:r=>this.handleValidation(r),onShippingContactSelected:r=>this.handleShippingContactSelected(r),onPaymentMethodSelected:r=>this.handlePaymentMethodSelected(r),onShippingMethodSelected:r=>this.handleShippingMethodSelected(r),onPaymentAuthorized:r=>this.handlePaymentAuthorized(r)})),o(1),P(t=>E(()=>t)),le(()=>{this.deleteUserAddresses(),this.paymentInProgress=!1})))}isApplePaySupported(e){return this.applePaySessionWrapperService.isApplePaySupported(e)}deleteUserAddresses(){this.transactionDetails.addressIds.length&&(this.opfQuickBuyTransactionService.deleteUserAddresses([...this.transactionDetails.addressIds]),this.transactionDetails.addressIds=[])}handleValidation(e){return this.validateOpfAppleSession(e)}setApplePayRequestConfig(e){this.transactionDetails=this.initTransactionDetails(e);let t=e?.countryCode||"",r=y(d({},this.defaultApplePayCardParameters),{currencyCode:this.transactionDetails.total.currency,total:{amount:this.transactionDetails.total.amount,label:this.transactionDetails.total.label},countryCode:t});return w({deliveryInfo:this.opfQuickBuyTransactionService.getTransactionDeliveryInfo(),merchantName:this.opfQuickBuyTransactionService.getMerchantName()}).pipe(a(({deliveryInfo:s,merchantName:c})=>(this.transactionDetails.total.label=c,r.total.label=c,this.transactionDetails.deliveryInfo=s,l(void 0))),u(s=>(s&&(this.transactionDetails.deliveryInfo=s),r)))}validateOpfAppleSession(e){return this.opfQuickBuyTransactionService.handleCartGuestUser().pipe(a(()=>this.opfQuickBuyTransactionService.getCurrentCartId()),a(t=>{let r={validationUrl:e.validationURL,initiative:"web",initiativeContext:(this.winRef?.nativeWindow).location?.hostname,cartId:t};return this.verifyApplePaySession(r)}))}convertAppleToOpfAddress(e,t=!1){let r="[FIELD_NOT_SET]";return{firstName:t?r:e?.givenName,lastName:t?r:e?.familyName,line1:t?r:e?.addressLines?.[0],line2:e?.addressLines?.[1],email:e?.emailAddress,town:e?.locality,district:e?.administrativeArea,postalCode:e?.postalCode,phone:e?.phoneNumber,country:{isocode:e?.countryCode,name:e?.country},defaultAddress:!1}}handleShippingContactSelected(e){let t=this.convertAppleToOpfAddress(e.shippingContact,!0),r=this.updateApplePayForm(d({},this.transactionDetails.total));return this.opfQuickBuyTransactionService.setDeliveryAddress(t).pipe(C(s=>{this.recordDeliveryAddress(s)}),a(()=>this.opfQuickBuyTransactionService.getSupportedDeliveryModes()),o(1),u(s=>{if(!s.length)return l(y(d({},r),{errors:[this.getApplePayFormWithError("No shipment methods available for this delivery address")]}));let c=s.map(p=>({identifier:p.code,label:p.name,amount:(p.deliveryCost?.value).toFixed(2),detail:p.description??p.name}));return r.newShippingMethods=c,r}),a(()=>this.opfQuickBuyTransactionService.getCurrentCartTotalPrice()),a(s=>s?(this.transactionDetails.total.amount=s.toString(),r.newTotal.amount=s.toString(),l(r)):E(()=>new Error("Total Price not available"))))}handlePaymentMethodSelected(e){let t=this.updateApplePayForm(d({},this.transactionDetails.total));return l(t)}handleShippingMethodSelected(e){let t=this.updateApplePayForm(d({},this.transactionDetails.total));return this.opfQuickBuyTransactionService.setDeliveryMode(e.shippingMethod.identifier).pipe(a(()=>this.opfQuickBuyTransactionService.getCurrentCart()),o(1),a(r=>r?.totalPrice?.value?(t.newTotal.amount=r.totalPrice.value.toString(),this.transactionDetails.total.amount=r.totalPrice.value.toString(),l(t)):E(()=>new Error("Total Price not available"))))}handlePaymentAuthorized(e){let t={status:this.applePaySessionWrapperService.statusSuccess},r;return this.placeOrderAfterPayment(e.payment).pipe(u(s=>(r=s,r?t:y(d({},t),{status:this.applePaySessionWrapperService.statusFailure}))),P(s=>l(y(d({},t),{status:this.applePaySessionWrapperService.statusFailure,errors:[this.getApplePayFormWithError(s?.message??"Payment error")]}))))}verifyApplePaySession(e){return this.opfQuickBuyFacade.getApplePayWebSession(e)}recordDeliveryAddress(e){this.transactionDetails.addressIds?.includes(e)||this.transactionDetails.addressIds?.push(e)}placeOrderAfterPayment(e){if(!e)return l(!1);let{shippingContact:t,billingContact:r}=e;if(!r)throw new Error("Error: empty billingContact");if(this.transactionDetails.deliveryInfo?.type===h.SHIPPING&&!t)throw new Error("Error: empty shippingContact");return(this.transactionDetails.deliveryInfo?.type===h.PICKUP?this.opfQuickBuyTransactionService.setDeliveryMode(h.PICKUP.toLocaleLowerCase()).pipe(a(()=>this.opfQuickBuyTransactionService.setBillingAddress(this.convertAppleToOpfAddress(r)))):this.opfQuickBuyTransactionService.setDeliveryAddress(this.convertAppleToOpfAddress(t)).pipe(C(c=>{this.recordDeliveryAddress(c)}),a(()=>this.opfQuickBuyTransactionService.setBillingAddress(this.convertAppleToOpfAddress(r))))).pipe(a(()=>t?.emailAddress?this.opfQuickBuyTransactionService.updateCartGuestUserEmail(t.emailAddress):l(!0)),a(()=>{let c=btoa(JSON.stringify(e.token.paymentData));return this.opfPaymentFacade.submitPayment({additionalData:[],paymentSessionId:"",callbacks:{onSuccess:()=>{},onPending:()=>{},onFailure:()=>{}},paymentMethod:k.APPLE_PAY,encryptedToken:c})}))}updateApplePayForm(e){return{newTotal:{amount:e.amount,label:e.label}}}getApplePayFormWithError(e,t="unknown"){return{code:t,message:e}}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=f({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})(),ft=(()=>{class i{constructor(){this.applePayService=n(yt),this.currentProductService=n(re),this.opfQuickBuyTransactionService=n(ee)}ngOnInit(){this.applePayDigitalWallet=this.activeConfiguration?.digitalWalletQuickBuy?.find(e=>e.provider===k.APPLE_PAY),!(!this.applePayDigitalWallet?.merchantId||!this.applePayDigitalWallet?.countryCode)&&(this.isApplePaySupported$=this.applePayService.isApplePaySupported(this.applePayDigitalWallet.merchantId))}initActiveCartTransaction(){return this.opfQuickBuyTransactionService.getCurrentCart().pipe(o(1),a(e=>this.applePayService.start({cart:e,countryCode:this.applePayDigitalWallet?.countryCode})))}initTransaction(){this.opfQuickBuyTransactionService.getTransactionLocationContext().pipe(o(1),a(()=>this.initActiveCartTransaction())).subscribe()}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275cmp=Q({type:i,selectors:[["cx-opf-apple-pay"]],inputs:{activeConfiguration:"activeConfiguration"},standalone:!1,decls:2,vars:3,consts:[[4,"ngIf"],[1,"apple-pay-button",3,"click"]],template:function(t,r){t&1&&(T(0,st,2,0,"ng-container",0),x(1,"async")),t&2&&m("ngIf",W(1,1,r.isApplePaySupported$))},dependencies:[q,j],encapsulation:2,changeDetection:0})}}return i})(),gt=(()=>{class i{static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275mod=v({type:i})}static{this.\u0275inj=g({imports:[M]})}}return i})(),se=(()=>{class i{constructor(){this.opfBaseFacade=n(He),this.checkoutConfig=n(Re),this.authService=n(V),this.userIdService=n(b),this.cartGuestUserFacade=n(Z),this.activeCartFacade=n(F),this.multiCartFacade=n(K)}getPaymentGatewayConfiguration(){return this.opfBaseFacade.getActiveConfigurationsState().pipe(u(e=>(e?.data?.value||[]).filter(t=>t?.providerType===qe.PAYMENT_GATEWAY)[0]))}getQuickBuyProviderConfig(e,t){let r;return t&&t.digitalWalletQuickBuy&&(r=t?.digitalWalletQuickBuy.find(s=>s.provider===e)),r}isQuickBuyProviderEnabled(e,t){let r=!1;return t&&t.digitalWalletQuickBuy&&(r=!!t?.digitalWalletQuickBuy.find(s=>s.provider===e)?.enabled),r}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=f({token:i,factory:i.\u0275fac})}}return i})(),it=(()=>{class i{constructor(){this.opfResourceLoaderService=n(je),this.currentProductService=n(re),this.opfPaymentFacade=n(ne),this.opfQuickBuyTransactionService=n(ee),this.opfQuickBuyButtonsService=n(se),this.opfQuickBuyConfig=n(Ve),this.googlePaymentClientOptions={environment:"TEST"},this.initialGooglePaymentRequest={apiVersion:2,apiVersionMinor:0,callbackIntents:["PAYMENT_AUTHORIZATION","SHIPPING_ADDRESS","SHIPPING_OPTION"],merchantInfo:{merchantName:_},shippingOptionRequired:!0,shippingAddressRequired:!0,shippingAddressParameters:{phoneNumberRequired:!1},emailRequired:!0},this.defaultGooglePayCardParameters={allowedAuthMethods:["PAN_ONLY","CRYPTOGRAM_3DS"],allowedCardNetworks:["AMEX","DISCOVER","INTERAC","JCB","MASTERCARD","VISA"],billingAddressRequired:!0,billingAddressParameters:{format:"FULL"}},this.initialTransactionInfo={totalPrice:"0.00",totalPriceStatus:"ESTIMATED",currencyCode:"USD"},this.initialTransactionDetails={context:I.PRODUCT,product:void 0,cart:void 0,quantity:0,deliveryInfo:{type:h.SHIPPING,pickupDetails:void 0},addressIds:[],total:{label:"",amount:"",currency:""}},this.googlePaymentRequest=this.initialGooglePaymentRequest,this.transactionDetails=this.initialTransactionDetails}updateGooglePaymentClient(){this.googlePaymentClient=new google.payments.api.PaymentsClient(this.googlePaymentClientOptions)}setGooglePaymentRequestConfig(e,t){e===h.PICKUP?(this.googlePaymentClientOptions=y(d({},this.googlePaymentClientOptions),{paymentDataCallbacks:{onPaymentAuthorized:this.handlePaymentCallbacks().onPaymentAuthorized}}),this.googlePaymentRequest=y(d({},this.initialGooglePaymentRequest),{shippingAddressRequired:!1,shippingOptionRequired:!1,callbackIntents:["PAYMENT_AUTHORIZATION"]})):(this.googlePaymentClientOptions=y(d({},this.googlePaymentClientOptions),{paymentDataCallbacks:this.handlePaymentCallbacks()}),this.googlePaymentRequest=this.initialGooglePaymentRequest),this.googlePaymentRequest.merchantInfo.merchantName=t,this.updateGooglePaymentClient()}loadResources(){let e=this.opfQuickBuyConfig?.providers?.[ze];return e?.resourceUrl?.length?this.opfResourceLoaderService.loadResources([{url:e.resourceUrl}]):Promise.reject("Config not found")}initClient(e){this.setAllowedPaymentMethodsConfig(e),this.updateGooglePaymentClient()}getClient(){return this.googlePaymentClient}isReadyToPay(){return this.googlePaymentClient.isReadyToPay(this.googlePaymentRequest)}updateTransactionInfo(e){this.googlePaymentRequest.transactionInfo=e}getShippingOptionParameters(){return this.opfQuickBuyTransactionService.getSupportedDeliveryModes().pipe(o(1),u(e=>({defaultSelectedOptionId:e[0]?.code,shippingOptions:e?.map(t=>({id:t?.code,label:t?.name,description:t?.description}))})))}getNewTransactionInfo(e){let t,r=e?.totalPriceWithTax;return r&&r.value&&r.currencyIso&&(t={totalPrice:r.value.toString(),currencyCode:r.currencyIso.toString(),totalPriceStatus:"FINAL"}),t}setDeliveryAddress(e){let t=this.convertAddress(e);return this.transactionDetails?.deliveryInfo?.type===h.SHIPPING?this.opfQuickBuyTransactionService.setDeliveryAddress(t).pipe(C(r=>{this.associateAddressId(r)})):l(h.PICKUP)}setBillingAddress(e){return this.opfQuickBuyTransactionService.setBillingAddress(this.convertAddress(e))}setDeliveryMode(e,t){return t===h.PICKUP&&(e=h.PICKUP.toLocaleLowerCase()),!e&&t===h.SHIPPING?l(void 0):e&&this.verifyShippingOption(e)?this.opfQuickBuyTransactionService.setDeliveryMode(e):l(void 0)}convertAddress(e){let t={firstName:X,lastName:X,country:{isocode:e?.countryCode},town:e?.locality,district:e?.administrativeArea,postalCode:e?.postalCode,line1:e?.address1||X,line2:`${e?.address2} ${e?.address3}`};return e?.name&&(t=d(d({},t),this.getFirstAndLastName(e?.name))),t}handleActiveCartTransaction(){return this.transactionDetails.context=I.CART,this.opfQuickBuyTransactionService.handleCartGuestUser().pipe(a(()=>w({deliveryInfo:this.opfQuickBuyTransactionService.getTransactionDeliveryInfo(),merchantName:this.opfQuickBuyTransactionService.getMerchantName()}).pipe(a(({deliveryInfo:e,merchantName:t})=>(this.transactionDetails.deliveryInfo=e,this.setGooglePaymentRequestConfig(e.type,t),this.setDeliveryMode(void 0,e.type).pipe(a(()=>this.opfQuickBuyTransactionService.getCurrentCart().pipe(o(1),C(r=>{this.transactionDetails.cart=r,this.updateTransactionInfo({totalPrice:`${r.totalPrice?.value}`,currencyCode:r.totalPrice?.currencyIso||this.initialTransactionInfo.currencyCode,totalPriceStatus:this.initialTransactionInfo.totalPriceStatus})})))))))))}initTransaction(){this.transactionDetails=y(d({},this.initialTransactionDetails),{addressIds:[]}),this.opfQuickBuyTransactionService.getTransactionLocationContext().pipe(a(e=>(this.transactionDetails.context=e,this.handleActiveCartTransaction()))).subscribe(()=>{this.googlePaymentClient.loadPaymentData(this.googlePaymentRequest).catch(e=>{e.statusCode==="CANCELED"&&this.deleteAssociatedAddresses()})})}renderPaymentButton(e){e.nativeElement.appendChild(this.getClient().createButton({onClick:()=>this.initTransaction(),buttonSizeMode:"fill"}))}handlePaymentCallbacks(){return{onPaymentAuthorized:e=>te(this.setDeliveryAddress(e.shippingAddress).pipe(a(()=>this.setBillingAddress(e.paymentMethodData.info?.billingAddress)),a(()=>e?.email?this.opfQuickBuyTransactionService.updateCartGuestUserEmail(e.email):l(!0)),a(()=>{let t=btoa(e.paymentMethodData.tokenizationData.token);return this.opfPaymentFacade.submitPayment({additionalData:[],paymentSessionId:"",callbacks:{onSuccess:()=>{},onPending:()=>{},onFailure:()=>{}},paymentMethod:k.GOOGLE_PAY,encryptedToken:t})}),P(()=>l(!1)))).then(t=>(this.deleteAssociatedAddresses(),{transactionState:t?"SUCCESS":"ERROR"})),onPaymentDataChanged:e=>te(this.setDeliveryAddress(e.shippingAddress).pipe(a(()=>this.getShippingOptionParameters()),a(t=>{let r=this.verifyShippingOption(e.shippingOptionData?.id)??t?.defaultSelectedOptionId;return this.setDeliveryMode(r).pipe(a(()=>w([this.opfQuickBuyTransactionService.getCurrentCart(),this.opfQuickBuyTransactionService.getSelectedDeliveryMode()])),a(([s,c])=>{let p={newShippingOptionParameters:t,newTransactionInfo:this.getNewTransactionInfo(s)};return p.newShippingOptionParameters?.defaultSelectedOptionId&&(p.newShippingOptionParameters.defaultSelectedOptionId=c?.code),l(p)}))})))}}verifyShippingOption(e){return e==="shipping_option_unselected"?void 0:e}associateAddressId(e){this.isAddressIdAssociated(e)||this.transactionDetails.addressIds.push(e)}isAddressIdAssociated(e){return this.transactionDetails.addressIds.includes(e)}resetAssociatedAddresses(){this.transactionDetails.addressIds=[]}deleteAssociatedAddresses(){this.transactionDetails.addressIds?.length&&(this.opfQuickBuyTransactionService.deleteUserAddresses(this.transactionDetails.addressIds),this.resetAssociatedAddresses())}getFirstAndLastName(e){let t=e?.split(" ")[0],r=e?.substring(t?.length)||t;return{firstName:t,lastName:r}}setAllowedPaymentMethodsConfig(e){let t=this.opfQuickBuyButtonsService.getQuickBuyProviderConfig(k.GOOGLE_PAY,e);this.googlePaymentRequest.allowedPaymentMethods=[{parameters:d({},this.defaultGooglePayCardParameters),tokenizationSpecification:{parameters:{gateway:String(t?.googlePayGateway),gatewayMerchantId:String(e.merchantId)},type:e.providerType},type:"CARD"}]}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=f({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})(),vt=(()=>{class i{constructor(){this.opfGooglePayService=n(it),this.changeDetectionRef=n(Ae),this.isReadyToPayState$=new ce(!1)}ngOnInit(){this.opfGooglePayService.loadResources().then(()=>{this.opfGooglePayService.initClient(this.activeConfiguration),this.opfGooglePayService.isReadyToPay().then(e=>{this.isReadyToPayState$.next(!!e?.result),this.changeDetectionRef.detectChanges(),e.result&&this.googlePayButtonContainer&&this.opfGooglePayService.renderPaymentButton(this.googlePayButtonContainer)})})}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275cmp=Q({type:i,selectors:[["cx-opf-google-pay"]],viewQuery:function(t,r){if(t&1&&Se(ot,5),t&2){let s;Pe(s=Ce())&&(r.googlePayButtonContainer=s.first)}},inputs:{activeConfiguration:"activeConfiguration"},standalone:!1,decls:2,vars:3,consts:[["googlePayButtonContainer",""],[4,"ngIf"],["class","cx-opf-google-pay-button",4,"ngIf"],[1,"cx-opf-google-pay-button"]],template:function(t,r){t&1&&(T(0,pt,2,1,"ng-container",1),x(1,"async")),t&2&&m("ngIf",W(1,1,r.isReadyToPayState$))},dependencies:[q,j],encapsulation:2,changeDetection:0})}}return i})(),mt=(()=>{class i{static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275mod=v({type:i})}static{this.\u0275inj=g({providers:[it],imports:[M]})}}return i})(),St=(()=>{class i{constructor(){this.opfQuickBuyButtonsService=n(se),this.PAYMENT_METHODS=k}ngOnInit(){this.paymentGatewayConfig$=this.opfQuickBuyButtonsService.getPaymentGatewayConfiguration()}isPaymentMethodEnabled(e,t){return this.opfQuickBuyButtonsService.isQuickBuyProviderEnabled(e,t)}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275cmp=Q({type:i,selectors:[["cx-opf-quick-buy-buttons"]],standalone:!1,decls:2,vars:3,consts:[[4,"ngIf"],[3,"activeConfiguration",4,"ngIf"],[3,"activeConfiguration"]],template:function(t,r){t&1&&(T(0,ut,3,2,"ng-container",0),x(1,"async")),t&2&&m("ngIf",W(1,1,r.paymentGatewayConfig$))},dependencies:[q,ft,vt,j],encapsulation:2,changeDetection:0})}}return i})(),Pt=(()=>{class i{static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275mod=v({type:i})}static{this.\u0275inj=g({providers:[se,H({cmsComponents:{OpfQuickBuyButtonsComponent:{component:St}}})],imports:[M,gt,mt]})}}return i})(),rt=(()=>{class i{static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275mod=v({type:i})}static{this.\u0275inj=g({imports:[Pt]})}}return i})();var Ct=(()=>{class i{constructor(){this.http=n(Te),this.converter=n(Ee),this.opfEndpointsService=n(Ke),this.config=n(Le),this.opfMetadataStatePersistanceService=n(We),this.logger=n(Y),this.headerWithNoLanguage={accept:"application/json","Content-Type":"application/json"},this.headerWithContentLanguage=y(d({},this.headerWithNoLanguage),{"Content-Language":this.opfMetadataStatePersistanceService.getActiveLanguage()})}getApplePayWebSession(e,t){let r=new De(this.headerWithContentLanguage).set(Ge,this.config.opf?.commerceCloudPublicKey||"").set(Ue,t||""),s=this.getApplePayWebSessionEndpoint();return this.http.post(s,e,{headers:r}).pipe(P(c=>{throw z(c,this.logger)}),$({shouldRetry:Oe,maxTries:2}),this.converter.pipeable(et))}getApplePayWebSessionEndpoint(){return this.opfEndpointsService.buildUrl("getApplePayWebSession")}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=f({token:i,factory:i.\u0275fac})}}return i})(),At={backend:{opfApi:{endpoints:{getApplePayWebSession:"payments/apple-pay-web-sessions"}}}},nt=(()=>{class i{static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275mod=v({type:i})}static{this.\u0275inj=g({providers:[H(At),{provide:R,useClass:Ct}],imports:[M]})}}return i})();var gi=(()=>{class i{static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275mod=v({type:i})}static{this.\u0275inj=g({imports:[rt,Xe,nt]})}}return i})();export{gi as OpfQuickBuyModule};
