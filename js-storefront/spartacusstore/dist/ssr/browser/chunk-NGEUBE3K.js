import{b as G,c as f,d as o,e as P,f as q}from"./chunk-TTSQTH3J.js";import{g as V}from"./chunk-WPN2OLOU.js";import{H as Z,I as B}from"./chunk-EU5ZHKTW.js";import{Af as T,I as S,J as c,Le as H,Pe as U,Za as L,_d as x,_e as A,af as O,da as w,ee as j,ga as R,i as N,m as y,ma as d,me as I,mf as b,n as _,na as k,o as h,oa as u,q as g,qa as i,r as E,yg as z,zf as Y}from"./chunk-PRP3ZKGZ.js";import{a as l,b as C}from"./chunk-25N2FLV6.js";var ue=new u("OpfPaymentConfigSerializer"),M=class{},F=(()=>{class r{constructor(){this.adapter=i(M)}verifyPayment(e,t){return this.adapter.verifyPayment(e,t)}submitPayment(e,t,n){return this.adapter.submitPayment(e,t,n)}submitCompletePayment(e,t,n){return this.adapter.submitCompletePayment(e,t,n)}getAfterRedirectScripts(e){return this.adapter.getAfterRedirectScripts(e)}initiatePayment(e){return this.adapter.initiatePayment(e)}static{this.\u0275fac=function(t){return new(t||r)}}static{this.\u0275prov=d({token:r,factory:r.\u0275fac})}}return r})(),D=class{},Q=(()=>{class r{constructor(){this.adapter=i(D)}setCartPaymentOption(e,t,n,m){return this.adapter.setCartPaymentOption(e,t,n,m)}static{this.\u0275fac=function(t){return new(t||r)}}static{this.\u0275prov=d({token:r,factory:r.\u0275fac})}}return r})(),$=(()=>{class r{constructor(){this.globalMessageService=i(T),this.routingService=i(I)}displayError(e){this.globalMessageService.add({key:e?.message?e.message:f.message},Y.MSG_TYPE_ERROR)}handleBadRequestError(e){let t=f.message;switch(e){case o.EXPIRED:t="opfPayment.errors.cardExpired";break;case o.INSUFFICIENT_FUNDS:case o.CREDIT_LIMIT:t="opfPayment.errors.insufficientFunds";break;case o.INVALID_CARD:case o.INVALID_CVV:t="opfPayment.errors.invalidCreditCard";break;case o.LOST_CARD:t="opfPayment.errors.cardReportedLost";break}return t}handlePaymentError(e,t){let n=f.message;e?.status===z.BAD_REQUEST?n=this.handleBadRequestError(e?.type):e?.type===o.PAYMENT_CANCELLED&&(n="opfPayment.errors.cancelPayment"),this.displayError(e?C(l({},e),{message:n}):void 0),t?.length&&this.routingService.go({cxRoute:t})}static{this.\u0275fac=function(t){return new(t||r)}}static{this.\u0275prov=d({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();function W(r){return{acceptHeader:"application/json",colorDepth:r?.screen?.colorDepth,javaEnabled:!1,javaScriptEnabled:!0,language:r?.navigator?.language,screenHeight:r?.screen?.height,screenWidth:r?.screen?.width,userAgent:r?.navigator?.userAgent,originUrl:r?.location?.origin,timeZoneOffset:new Date().getTimezoneOffset()}}var X=(()=>{class r{constructor(){this.opfPaymentConnector=i(F),this.winRef=i(j),this.cartAccessCodeFacade=i(B),this.activeCartFacade=i(Z),this.userIdService=i(x),this.routingService=i(I),this.orderFacade=i(V),this.globalMessageService=i(T),this.opfPaymentErrorHandlerService=i($)}submitPayment(e){let{paymentMethod:t,additionalData:n,paymentSessionId:m,returnPath:v,encryptedToken:a}=e,p={paymentMethod:t,additionalData:n,channel:"BROWSER",browserInfo:W(this.winRef.nativeWindow)};return t!==q.CREDIT_CARD&&(p.encryptedToken=""),a&&(p.encryptedToken=a),this.getCartAccessCode(p).pipe(c(([s,{accessCode:K}])=>this.opfPaymentConnector.submitPayment(s,K,m)),c(s=>this.paymentResponseHandler(s,e.callbacks)),R(s=>{s&&this.routingService.go({cxRoute:"orderConfirmation"})}),g(s=>!!s),S(s=>(this.opfPaymentErrorHandlerService.handlePaymentError(s,v),h(s))),b({shouldRetry:A,maxTries:O}))}submitCompletePayment(e){let{additionalData:t,paymentSessionId:n,returnPath:m}=e,v={additionalData:t,paymentSessionId:n};return this.getCartAccessCode(v).pipe(c(([a,{accessCode:p}])=>this.opfPaymentConnector.submitCompletePayment(a,p,n)),c(a=>this.paymentResponseHandler(a,e.callbacks)),R(a=>{a&&this.routingService.go({cxRoute:"orderConfirmation"})}),g(a=>!!a),S(a=>(this.opfPaymentErrorHandlerService.handlePaymentError(a,m),h(()=>a))),b({shouldRetry:A,maxTries:O}))}paymentResponseHandler(e,t){return e.status===P.ACCEPTED||e.status===P.DELAYED?y(Promise.resolve(t.onSuccess(e))).pipe(c(()=>this.orderFacade.placePaymentAuthorizedOrder(!0))):e.status===P.PENDING?y(Promise.resolve(t.onPending(e))).pipe(c(()=>N)):e.status===P.REJECTED?y(Promise.resolve(t.onFailure(e))).pipe(c(()=>h(C(l({},f),{type:o.PAYMENT_REJECTED})))):y(Promise.resolve(t.onFailure(e))).pipe(c(()=>h(C(l({},f),{type:o.STATUS_NOT_RECOGNIZED}))))}getCartAccessCode(e){return E([this.userIdService.takeUserId(),this.activeCartFacade.takeActiveCartId()]).pipe(w(([t,n])=>E([_(e),this.cartAccessCodeFacade.getCartAccessCode(t,n)])))}static{this.\u0275fac=function(t){return new(t||r)}}static{this.\u0275prov=d({token:r,factory:r.\u0275fac})}}return r})(),J=(()=>{class r{constructor(){this.queryService=i(U),this.commandService=i(H),this.opfPaymentConnector=i(F),this.opfPaymentOccConnector=i(Q),this.opfPaymentHostedFieldsService=i(X),this.verifyPaymentCommand=this.commandService.create(e=>this.opfPaymentConnector.verifyPayment(e.paymentSessionId,e.paymentVerificationPayload)),this.submitPaymentCommand=this.commandService.create(e=>this.opfPaymentHostedFieldsService.submitPayment(e.submitInput)),this.submitCompletePaymentCommand=this.commandService.create(e=>this.opfPaymentHostedFieldsService.submitCompletePayment(e.submitCompleteInput)),this.getAfterRedirectScriptsCommand=this.commandService.create(e=>this.opfPaymentConnector.getAfterRedirectScripts(e.paymentSessionId)),this.initiatePaymentCommand=this.commandService.create(e=>this.opfPaymentConnector.initiatePayment(e.paymentConfig)),this.setCartPaymentOptionCommand=this.commandService.create(e=>this.opfPaymentOccConnector.setCartPaymentOption(e.userId,e.cartId,e.sapPaymentOptionId,e.purchaseOrderNumber))}verifyPayment(e,t){return this.verifyPaymentCommand.execute({paymentSessionId:e,paymentVerificationPayload:t})}submitPayment(e){return this.submitPaymentCommand.execute({submitInput:e})}submitCompletePayment(e){return this.submitCompletePaymentCommand.execute({submitCompleteInput:e})}getAfterRedirectScripts(e){return this.getAfterRedirectScriptsCommand.execute({paymentSessionId:e})}initiatePayment(e){return this.initiatePaymentCommand.execute({paymentConfig:e})}setCartPaymentOption(e,t,n,m){return this.setCartPaymentOptionCommand.execute({userId:e,cartId:t,sapPaymentOptionId:n,purchaseOrderNumber:m})}static{this.\u0275fac=function(t){return new(t||r)}}static{this.\u0275prov=d({token:r,factory:r.\u0275fac})}}return r})(),ee=[J,X,{provide:G,useExisting:J}],fe=(()=>{class r{static{this.\u0275fac=function(t){return new(t||r)}}static{this.\u0275mod=L({type:r})}static{this.\u0275inj=k({providers:[...ee,F,Q]})}}return r})(),pe=new u("OpfPaymentVerificationNormalizer"),ye=new u("OpfPaymentSubmitNormalizer"),he=new u("OpfPaymentSubmitCompleteNormalizer"),Pe=new u("OpfAfterRedirectScriptsNormalizer");export{ue as a,M as b,D as c,W as d,fe as e,pe as f,ye as g,he as h,Pe as i};
