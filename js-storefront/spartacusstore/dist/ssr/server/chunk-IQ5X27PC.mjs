import './polyfills.server.mjs';
import{b as re,c as M}from"./chunk-ROMJESGS.mjs";import{f as ie,h as c,k as ne}from"./chunk-B74IYF2B.mjs";import{g as te}from"./chunk-ZOJN3DPF.mjs";import{O as ee}from"./chunk-HCL456IH.mjs";import{$ as z,Aa as K,Ca as Q,Q as W,R as X,V as q}from"./chunk-M3PBDWUL.mjs";import{D as p,Db as N,Eb as L,Fb as S,Gb as b,Hb as x,J as o,M as P,Mb as C,Md as j,Td as k,We as Z,Xa as T,Xg as B,Yc as U,a as A,bd as H,db as O,eb as g,fb as I,ga as _,hd as Y,hg as R,ig as $,jb as v,kc as V,lc as G,m as F,ma as y,n as d,na as D,o as a,q as s,qa as r,qe as w,tb as u,yh as J}from"./chunk-JI3YDV22.mjs";import{a as E,b as h}from"./chunk-H4UZCO6D.mjs";function se(e,ae){if(e&1&&(S(0,"cx-card",2),V(1,"async")),e&2){let t=C(2);u("content",G(1,1,t.getPaymentMethodDetailsCardContent(t.order.paymentInfo.sapPaymentMethod)))}}function ce(e,ae){if(e&1&&(b(0),v(1,se,2,3,"cx-card",1),x()),e&2){let t=C();T(),u("ngIf",t.order.paymentInfo)}}var fe={routing:{routes:{paymentVerificationResult:{paths:["opf/payment-verification-redirect/result"]},paymentVerificationCancel:{paths:["opf/payment-verification-redirect/cancel"]}}}},de="opfPayment",pe=(()=>{class e{static{this.\u0275fac=function(i){return new(i||e)}}static{this.\u0275prov=y({token:e,factory:()=>J({facade:e,feature:de,methods:["verifyPayment","submitPayment","submitCompletePayment","getAfterRedirectScripts","initiatePayment","setCartPaymentOption"]}),providedIn:"root"})}}return e})(),Ue={statusText:"Payment Error",message:"opfPayment.errors.proceedPayment",status:-1,type:""},ue=function(e){return e.EXPIRED="EXPIRED",e.INSUFFICIENT_FUNDS="INSUFFICIENT_FUNDS",e.CREDIT_LIMIT="CREDIT_LIMIT",e.INVALID_CARD="INVALID_CARD",e.INVALID_CVV="INVALID_CVV",e.LOST_CARD="LOST_CARD",e.PAYMENT_REJECTED="PAYMENT_REJECTED",e.PAYMENT_CANCELLED="PAYMENT_CANCELLED",e.STATUS_NOT_RECOGNIZED="STATUS_NOT_RECOGNIZED",e}(ue||{}),l=function(e){return e.AUTHORIZED="AUTHORIZED",e.UNAUTHORIZED="UNAUTHORIZED",e.CANCELLED="CANCELLED",e.DELAYED="DELAYED",e}(l||{}),m=function(e){return e.OPF_AFTER_REDIRECT_SCRIPT_FLAG="opfAfterRedirectScriptFlag",e.OPF_PAYMENT_SESSION_ID="opfPaymentSessionId",e}(m||{}),le=function(e){return e.REJECTED="REJECTED",e.ACCEPTED="ACCEPTED",e.PENDING="PENDING",e.DELAYED="DELAYED",e}(le||{}),me=function(e){return e.CREDIT_CARD="CREDIT_CARD",e}(me||{}),Ee=function(e){return e.IFRAME="IFRAME",e.FULL_PAGE="FULL_PAGE",e.HOSTED_FIELDS="HOSTED_FIELDS",e}(Ee||{}),he=(()=>{class e{constructor(){this.translationService=r(B),this.orderOutlet=r(X),this.subscription=new A}ngOnInit(){this.orderOutlet?.context$&&this.subscription?.add(this.orderOutlet.context$.subscribe(t=>this.order=t?.item))}getPaymentMethodDetailsCardContent(t){return this.translationService.translate("opfCheckout.paymentOption").pipe(p(()=>!!t?.name),s(i=>({title:i,text:[t?.name]})))}isPaymentMethodDetailsInfoPresent(t){return!!t?.paymentInfo?.sapPaymentMethod?.name}ngOnDestroy(){this.subscription?.unsubscribe()}static{this.\u0275fac=function(i){return new(i||e)}}static{this.\u0275cmp=g({type:e,selectors:[["cx-opf-payment-method-details"]],standalone:!1,decls:1,vars:1,consts:[[4,"ngIf"],[3,"content",4,"ngIf"],[3,"content"]],template:function(i,n){i&1&&v(0,ce,2,1,"ng-container",0),i&2&&u("ngIf",n.isPaymentMethodDetailsInfoPresent(n.order))},dependencies:[U,K,H],encapsulation:2})}}return e})(),Pe=(()=>{class e{static{this.\u0275fac=function(i){return new(i||e)}}static{this.\u0275mod=I({type:e})}static{this.\u0275inj=D({providers:[q({id:ee.ORDER_OVERVIEW,position:W.BEFORE,component:he})],imports:[Y,Q]})}}return e})(),ye=(()=>{class e{constructor(){this.orderFacade=r(te),this.routingService=r(Z),this.globalMessageService=r($),this.opfPaymentFacade=r(pe),this.opfMetadataStoreService=r(ie),this.opfResourceLoaderService=r(ne),this.globalFunctionsService=r(re),this.opfDefaultPaymentError={statusText:"Payment Verification Error",message:"opfPayment.errors.proceedPayment",status:-1}}getParamsMap(t){return t?Object.entries(t).map(i=>({key:i[0],value:i[1]})):[]}findInParamsMap(t,i){return i.find(n=>n.key===t)?.value??void 0}goToPage(t){this.routingService.go({cxRoute:t})}verifyResultUrl(t){let i;return t?.routeConfig?.data?.cxRoute===c.RESULT_PAGE?t.queryParams.pipe(o(n=>(i=this.getParamsMap(n),this.getPaymentSessionId(i))),o(n=>n?d({paymentSessionId:n,paramsMap:i.filter(f=>f.key!==m.OPF_PAYMENT_SESSION_ID),afterRedirectScriptFlag:this.findInParamsMap(m.OPF_AFTER_REDIRECT_SCRIPT_FLAG,i)}):a(()=>this.opfDefaultPaymentError))):a(()=>h(E({},this.opfDefaultPaymentError),{message:"opfPayment.errors.cancelPayment"}))}getPaymentSessionId(t){if(t?.length){let i=this.findInParamsMap(m.OPF_PAYMENT_SESSION_ID,t);return i?d(i):this.getPaymentSessionIdFromStorage()}return this.getPaymentSessionIdFromStorage()}getPaymentSessionIdFromStorage(){return this.opfMetadataStoreService.getOpfMetadataState().pipe(P(1),s(t=>t?.opfPaymentSessionId))}placeOrder(){return this.orderFacade.placePaymentAuthorizedOrder(!0)}verifyPayment(t,i){return this.opfPaymentFacade.verifyPayment(t,{responseMap:[...i]}).pipe(o(n=>this.isPaymentSuccessful(n)))}isPaymentSuccessful(t){return t.result===l.AUTHORIZED||t.result===l.DELAYED?d(!0):t.result===l.CANCELLED?a(()=>h(E({},this.opfDefaultPaymentError),{message:"opfPayment.errors.cancelPayment"})):a(()=>this.opfDefaultPaymentError)}displayError(t){this.globalMessageService.add({key:t?.message&&t?.status===-1?t.message:"opfPayment.errors.proceedPayment"},R.MSG_TYPE_ERROR)}checkIfProcessingCartIdExist(){this.opfMetadataStoreService.getOpfMetadataState().pipe(P(1),p(t=>t.isPaymentInProgress===!1)).subscribe(()=>{this.goToPage(c.CART_PAGE),this.globalMessageService.add({key:"httpHandlers.cartNotFound"},R.MSG_TYPE_ERROR)})}runHostedPagePattern(t,i){return this.verifyPayment(t,i).pipe(o(()=>this.placeOrder()),s(n=>!!n),_(n=>{n&&this.goToPage(c.CONFIRMATION_PAGE)}))}runHostedFieldsPattern(t,i,n){return this.globalFunctionsService.registerGlobalFunctions({domain:M.REDIRECT,paymentSessionId:t,vcr:i,paramsMap:n}),this.opfPaymentFacade.getAfterRedirectScripts(t).pipe(o(f=>f?.afterRedirectScript?F(this.renderAfterRedirectScripts(f.afterRedirectScript)):a(this.opfDefaultPaymentError)))}renderAfterRedirectScripts(t){let i=t?.html;return new Promise(n=>{this.opfResourceLoaderService.loadResources(t.jsUrls,t.cssUrls).then(()=>{i?(this.opfResourceLoaderService.executeScriptFromHtml(i),n(!0)):n(!1)}).catch(()=>{n(!1)})})}removeResourcesAndGlobalFunctions(){this.globalFunctionsService.unregisterGlobalFunctions(M.REDIRECT),this.opfResourceLoaderService.clearAllResources()}static{this.\u0275fac=function(i){return new(i||e)}}static{this.\u0275prov=y({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})(),oe=(()=>{class e{constructor(){this.route=r(j),this.opfPaymentVerificationService=r(ye),this.vcr=r(O),this.isHostedFieldPattern=!1}ngOnInit(){this.opfPaymentVerificationService.checkIfProcessingCartIdExist(),this.subscription=this.opfPaymentVerificationService.verifyResultUrl(this.route).pipe(o(({paymentSessionId:t,paramsMap:i,afterRedirectScriptFlag:n})=>this.runPaymentPattern({paymentSessionId:t,paramsMap:i,afterRedirectScriptFlag:n}))).subscribe({error:t=>this.onError(t),next:t=>{t||this.onError(void 0)}})}runPaymentPattern({paymentSessionId:t,paramsMap:i,afterRedirectScriptFlag:n}){return n==="true"?(this.isHostedFieldPattern=!0,this.opfPaymentVerificationService.runHostedFieldsPattern(t,this.vcr,i)):this.opfPaymentVerificationService.runHostedPagePattern(t,i)}onError(t){this.opfPaymentVerificationService.displayError(t),this.opfPaymentVerificationService.goToPage(c.CHECKOUT_REVIEW_PAGE)}ngOnDestroy(){this.subscription&&this.subscription.unsubscribe(),this.isHostedFieldPattern&&this.opfPaymentVerificationService.removeResourcesAndGlobalFunctions()}static{this.\u0275fac=function(i){return new(i||e)}}static{this.\u0275cmp=g({type:e,selectors:[["cx-opf-verify-payment"]],standalone:!1,decls:2,vars:0,consts:[[1,"cx-spinner"]],template:function(i,n){i&1&&(N(0,"div",0),S(1,"cx-spinner"),L())},dependencies:[z],encapsulation:2})}}return e})();var He=(()=>{class e{static{this.\u0275fac=function(i){return new(i||e)}}static{this.\u0275mod=I({type:e})}static{this.\u0275inj=D({providers:[w(fe)],imports:[Pe,k.forChild([{path:null,component:oe,data:{cxRoute:"paymentVerificationResult"}},{path:null,component:oe,data:{cxRoute:"paymentVerificationCancel"}}])]})}}return e})();export{de as a,pe as b,Ue as c,ue as d,le as e,me as f,Ee as g,He as h};
